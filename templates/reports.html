{% extends "base.html" %}
{% block title %}Reports ‚Äì PDF A11y Auditor{% endblock %}
{% block content %}
  <div class="container">
    <h1>Audit Reports Overview</h1>
    <div class="log-container">
      <div class="log-header">
        <span>üñ•Ô∏è Live Server Log</span>
        <span id="log-status">Connecting...</span>
      </div>
      <div class="log-content" id="terminal-output">Waiting for logs...</div>
    </div>
    <h2>Downloads</h2>
    <table class="report-table">
      <thead>
        <tr>
          <th>Available Files</th>
          <th class="text-right">Action</th>
        </tr>
      </thead>
      <tbody id="file-list-body">
        {% for file in files %}
          <tr>
            <td>{{ file }}</td>
            <td class="text-right">
              {% if file.lower().endswith('.zip') %}
                <a href="/download/{{ file }}" class="btn-primary green font-09">üì¶ Download Fix-Pack (ZIP)</a>
              {% elif 'IMPROVED_REPORT' in file.upper() %}
                <a href="/download/{{ file }}" class="btn-primary green font-09">üìà View Success-Report (PDF)</a>
              {% else %}
                <a href="/download/{{ file }}" class="btn-primary font-09">üìÑ Download Main Report (PDF)</a>
              {% endif %}
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="2" class="text-center" style="padding: 2rem;">
              <em>No reports found yet. Start an audit first.</em>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <script>
    const logOutput = document.getElementById('terminal-output');
    const logStatus = document.getElementById('log-status');
    let isAutoScrolling = true;
    let reloadTriggered = false;

    function fetchLogs() {
        if (reloadTriggered) return;
        fetch('/api/logs')
            .then(response => response.json())
            .then(data => {
                if (data.logs) {
                    logOutput.textContent = data.logs;
                    logStatus.textContent = data.logs.trim() === "" ? "‚óè Idle" : "‚óè Live";
                    logStatus.className = data.logs.trim() === "" ? "status-idle" : "status-live";
                    if (isAutoScrolling) logOutput.scrollTop = logOutput.scrollHeight;
                    if (data.logs.includes("Prozess fertig.")) {
                        logStatus.textContent = "‚úÖ Done - Refreshing...";
                        reloadTriggered = true;
                        setTimeout(() => { window.location.reload(); }, 2500);
                    }
                }
            })
            .catch(() => { logStatus.textContent = "‚óã Offline"; });
    }
    setInterval(fetchLogs, 2000);
    fetchLogs();
  </script>
{% endblock %}
